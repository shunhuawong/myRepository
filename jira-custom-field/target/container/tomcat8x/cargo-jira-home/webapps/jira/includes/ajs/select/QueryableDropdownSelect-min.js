define("jira/ajs/select/queryable-dropdown-select",["jira/ajs/control","jira/ajs/select/suggestions/default-suggest-handler","jira/ajs/layer/inline-layer-factory","jira/ajs/list/list","jira/util/navigator","jira/util/assistive","jquery","underscore"],function(Control,DefaultSuggestHandler,InlineLayerFactory,List,Navigator,Assistive,jQuery,_){var SUGGESTIONS_ID_SUFFIX="-suggestions";var CONTROL_ID=0;return Control.extend({INVALID_KEYS:{"Shift":true,"Esc":true,"Right":true},init:function(options){this.suggestionsVisible=false;this._setOptions(options);this._createFurniture();this._createDropdownController();this._createSuggestionsController();this._createListController();this._assignEventsToFurniture();if(this.options.width){this.setFieldWidth(this.options.width)}if(this.options.loadOnInit){this.requestSuggestions(true)}},_createDropdownController:function(){var instance=this;if(this.options.dropdownController){this.dropdownController=this.options.dropdownController}else{this.dropdownController=InlineLayerFactory.createInlineLayers({offsetTarget:this.$field,width:this.$field.innerWidth(),content:this.options.element})}this.dropdownController.onhide(function(){instance.hideSuggestions()})},_createSuggestionsController:function(){this.suggestionsHandler=this.options.suggestionsHandler?new this.options.suggestionsHandler(this.options):new DefaultSuggestHandler(this.options)},_createListController:function(){var instance=this;this.listController=new List({containerSelector:this.options.element,groupSelector:"ul.aui-list-section",matchingStrategy:this.options.matchingStrategy,eventTarget:this.$field,selectionHandler:function(){instance.$field.val(AJS.I18n.getText("common.concepts.loading")).css("color","#999");instance.hideSuggestions();return true}})},_onItemFocus:function(e,item){var $field=this.$field;var id=(item&&item.id)?item.id:"null";Assistive.wait(function(){$field.attr("aria-activedescendant",id)})},setFieldWidth:function(width){this.$container.css({width:width,minWidth:width})},showErrorMessage:function(value){var $container=this.$container.parent(".field-group");this.hideErrorMessage();this.$errorMessage.text(AJS.format(this.options.errorMessage,value||this.getQueryVal()));if($container.length===1){$container.append(this.$errorMessage);return }if($container.length===0){$container=this.$container.parent(".frother-control-renderer")}if($container.length===1){this.$errorMessage.prependTo($container);return }if($container.length===0){this.$container.parent().append(this.$errorMessage)}},hideErrorMessage:function(){if(this.$errorMessage){this.$errorMessage.remove()}this.$container.parent().find(".error").remove()},_getDefaultOptions:function(){CONTROL_ID+=1;return{id:CONTROL_ID,keyInputPeriod:75,localListLiveUpdateLimit:25,localListLiveUpdateDelay:150}},_createFurniture:function(){this.$container=this._render("container").insertBefore(this.options.element);this.suggestionsContainerId=this.options.id+SUGGESTIONS_ID_SUFFIX;this.$field=this._render("field").appendTo(this.$container);this.$dropDownIcon=this._render("dropdownAndLoadingIcon",this._hasDropdownButton()).appendTo(this.$container);if(this.options.overlabel){this.$overlabel=this._render("overlabel").insertBefore(this.$field);this.$overlabel.overlabel()}},_hasDropdownButton:function(){return this.options.showDropdownButton||this.options.ajaxOptions&&this.options.ajaxOptions.minQueryLength===0},_assignEventsToFurniture:function(){var instance=this;this._assignEvents("ignoreBlurElement",this.dropdownController.$layer);this._assignEvents("container",this.$container);if(this._hasDropdownButton()){this._assignEvents("ignoreBlurElement",this.$dropDownIcon);this._assignEvents("dropdownAndLoadingIcon",this.$dropDownIcon)}setTimeout(function(){instance._assignEvents("field",instance.$field);instance._assignEvents("keys",instance.$field)},15);this.listController.bind("itemFocus",this._onItemFocus.bind(this))},requestSuggestions:function(force){var instance=this,deferred=jQuery.Deferred();this.outstandingRequest=this.suggestionsHandler.execute(this.getQueryVal(),force).done(function(descriptors,query){if(query===instance.getQueryVal()){deferred.resolve(descriptors,query)}});if(this.outstandingRequest.state()!=="resolved"){window.clearTimeout(this.loadingWait);this.loadingWait=window.setTimeout(function(){if(instance.outstandingRequest.state()==="pending"){instance.showLoading()}},150);this.outstandingRequest.always(function(){instance.hideLoading()})}return deferred},showLoading:function(){this.$dropDownIcon.addClass("loading").removeClass("noloading");if(!this.$dropDownIcon.data("spinner")){this.$dropDownIcon.spin()}this.$field.attr("aria-busy","true");return this},hideLoading:function(){this.$dropDownIcon.removeClass("loading").addClass("noloading");this.$dropDownIcon.spinStop();this.$field.attr("aria-busy","false");return this},_setSuggestions:function(data){if(data){this.listController.generateListFromJSON(data,this.getQueryVal());this.showSuggestions()}else{this.hideSuggestions()}this.$container.attr("data-query",this.getQueryVal())},disable:function(){if(!this.disabled){this.$container.addClass("aui-disabled");this.$disabledBlanket=this._render("disabledBlanket").appendTo(this.$container);this.$field.attr("disabled",true);this.dropdownController.hide();this.disabled=true}},enable:function(){if(this.disabled){this.$container.removeClass("aui-disabled");this.$disabledBlanket.remove();this.$field.attr("disabled",false);this.disabled=false}},getQueryVal:function(){return jQuery.trim(this.$field.val())},_isValidInput:function(event){return this.$field.is(":visible")&&!(event.type==="aui:keydown"&&this.INVALID_KEYS[event.key])},_handleCharacterInput:function(force){var queryLength=this.getQueryVal().length;if(queryLength>=1||force){this.requestSuggestions(force).done(_.bind(function(suggestions){this._setSuggestions(suggestions)},this))}else{this.hideSuggestions()}},_handleDown:function(e){if(!this.suggestionsVisible){this.listController._latestQuery="";this._handleCharacterInput(true)}e.preventDefault()},_rejectPendingRequests:function(){if(this.outstandingRequest){this.outstandingRequest.reject()}},showSuggestions:function(){if(this.suggestionsVisible){return }this.suggestionsVisible=true;this.dropdownController.show();this.dropdownController.setWidth(this.$field.innerWidth());this.dropdownController.setPosition();this.listController.enable();this.$field.attr("aria-expanded","true");this.$field.attr("aria-controls",this.suggestionsContainerId)},hideSuggestions:function(){if(!this.suggestionsVisible){return }this._rejectPendingRequests();this.suggestionsVisible=false;this.$dropDownIcon.addClass("noloading");this.dropdownController.hide();this.listController.disable();this.$field.removeAttr("aria-activedescendant");this.$field.attr("aria-expanded","false");this.$field.removeAttr("aria-controls")},_deactivate:function(){this.hideSuggestions()},_handleEscape:function(e){if(this.suggestionsVisible){e.stopPropagation();if(e.type==="keyup"){this.hideSuggestions();if(Navigator.isIE()&&Navigator.majorVersion()<12){this.$field.focus()}}}},acceptFocusedSuggestion:function(){var focused=this.listController.getFocused();if(focused.length!==0&&focused.is(":visible")){this.listController._acceptSuggestion(focused)}},keys:{"Down":function(e){if(this._hasDropdownButton()){this._handleDown(e)}},"Up":function(e){e.preventDefault()},"Return":function(e){e.preventDefault()}},onEdit:function(){this._handleCharacterInput()},_events:{dropdownAndLoadingIcon:{click:function(e){if(this.suggestionsVisible){this.hideSuggestions()}else{this._handleDown(e);this.$field.focus()}e.stopPropagation()}},container:{disable:function(){this.disable()},enable:function(){this.enable()}},field:{blur:function(){if(!this.ignoreBlurEvent){this._deactivate()}else{this.ignoreBlurEvent=false}},click:function(e){e.stopPropagation()},"keydown keyup":function(e){if(e.keyCode===27){this._handleEscape(e)}}},keys:{"aui:keydown input":function(event){this._handleKeyEvent(event)}},ignoreBlurElement:{mousedown:function(e){if(Navigator.isIE()&&Navigator.majorVersion()<12){var targetIsDropdownController=(jQuery(e.target)[0]==jQuery(this.dropdownController.$layer)[0]);if(targetIsDropdownController){this.ignoreBlurEvent=true}if(typeof document.addEventListener==="undefined"){if(!targetIsDropdownController){var field=this.$field.get(0);function onbeforedeactivate(event){event.returnValue=false}field.attachEvent("onbeforedeactivate",onbeforedeactivate);setTimeout(function(){field.detachEvent("onbeforedeactivate",onbeforedeactivate)},0)}return }}e.preventDefault()}}},_renders:{disabledBlanket:function(){return jQuery("<div class='aui-disabled-blanket' />").height(this.$field.outerHeight())},overlabel:function(){return jQuery("<span id='"+this.options.id+"-overlabel' data-target='"+this.options.id+"-field' class='overlabel'>"+this.options.overlabel+"</span>")},baseField:function(tagName){tagName=tagName||"input";return jQuery("<"+tagName+" />").attr({"autocomplete":"off","role":"combobox","aria-autocomplete":"list","aria-haspopup":"true","aria-expanded":"false"})},field:function(){return this._render("baseField").attr({"class":"text","id":this.options.id+"-field","type":"text"})},container:function(){return jQuery("<div class='queryable-select' id='"+this.options.id+"-queryable-container' />")},dropdownAndLoadingIcon:function(showDropdown){var $element=jQuery('<span class="icon noloading"><span>More</span></span>');if(showDropdown){$element.addClass("drop-menu")}return $element},suggestionsContainer:function(idPrefix){return jQuery("<div></div>").attr({"class":"aui-list","id":idPrefix+SUGGESTIONS_ID_SUFFIX,"tabindex":"-1","role":"listbox"})}}})});AJS.namespace("AJS.QueryableDropdown",null,require("jira/ajs/select/queryable-dropdown-select"));AJS.namespace("AJS.QueryableDropdownSelect",null,require("jira/ajs/select/queryable-dropdown-select"));