define("jira/field/assignee-picker",["jira/ajs/select/scrollable-single-select","jira/ajs/select/suggestions/assignee-suggest-handler","jira/ajs/list/group-descriptor","jira/ajs/list/item-descriptor","aui/params","jquery","underscore"],function(ScrollableSingleSelect,AssigneeSuggestHandler,GroupDescriptor,ItemDescriptor,params,$,_){function getAssigneeGroupSearch(suggestions){return _.find(suggestions,function(suggestion){return suggestion.id()==="assignee-group-search"})}return ScrollableSingleSelect.extend({init:function(options){var instance=this;var element=(options.element instanceof $)?options.element:$(options.element);instance._pagination={lastQuery:null,numberOfShowingItems:0,allResultsDisplayed:false,requestNextPagePromise:null};function data(query){params.actionDescriptorId=undefined;AJS.populateParameters();return{username:query,projectKeys:params.projectKeys,issueKey:params.assigneeEditIssueKey,actionDescriptorId:params.actionDescriptorId,maxResults:50,startAt:instance._pagination.numberOfShowingItems}}function formatResponse(response){var ret=[];if(response.length){var groupDescriptor=new GroupDescriptor({weight:1,id:"assignee-group-search",uniqueItemScope:"container",replace:true,label:AJS.I18n.getText("assignee.picker.group.search")});for(var i=0,len=response.length;i<len;i++){var user=response[i];var username=user.name;var displayName=user.displayName;var emailAddress=user.emailAddress;var label=displayName;if(emailAddress){label+=" - "+emailAddress}label+=" ("+username+")";groupDescriptor.addItem(new ItemDescriptor({value:username,fieldText:displayName,label:label,allowDuplicate:false,icon:user.avatarUrls["16x16"]}))}ret.push(groupDescriptor)}return ret}options=$.extend(true,{},{submitInputVal:true,showDropdownButton:!!element.data("show-dropdown-button"),errorMessage:AJS.I18n.getText("assignee.picker.invalid.user"),localDataGroupId:"assignee-group-suggested",content:"mixed",suggestionAtTop:true,removeDuplicates:true,ajaxOptions:{url:function(){params.assigneeEditIssueKey=undefined;AJS.populateParameters();var path=params.assigneeEditIssueKey?"search":"multiProjectSearch";return contextPath+"/rest/api/latest/user/assignable/"+path},query:true,minQueryLength:0,data:data,formatResponse:formatResponse}},options);if(options.editValue=="-1"){options.editValue=false;element.val("-1")}this._super(options);this.suggestionsHandler=new AssigneeSuggestHandler(this.options,this.model)},requestSuggestions:function(force){if(this._pagination.lastQuery!=this.getQueryVal()){this._resetPagination()}return this._super(force).done(_.bind(function(suggestions){var group=getAssigneeGroupSearch(suggestions);if(group){var groupItems=group.items();if(groupItems&&groupItems.length){this._pagination.numberOfShowingItems+=groupItems.length}}return suggestions},this))},scrolledToBottomHandler:function(){if((!this._pagination.requestNextPagePromise||this._pagination.requestNextPagePromise.isResolved())&&!this._pagination.allResultsDisplayed){this._pagination.requestNextPagePromise=this.requestSuggestions(true).done(_.bind(function(suggestions){var group=getAssigneeGroupSearch(suggestions);if(group){var groupItems=group.items();if(groupItems&&groupItems.length){this.listController.appendToGroupDescriptor("assignee-group-search",groupItems);this.listController.addNextPage()}else{this._pagination.allResultsDisplayed=true}}else{this._pagination.allResultsDisplayed=true}},this))}},_handleCharacterInput:function(force){if(this._pagination.lastQuery!=this.getQueryVal()){this._super(force)}else{if(force){this.showSuggestions()}}},handleFreeInput:function(value){if(""===$.trim(value||this.$field.val())){this.setSelection(this.model.getDescriptor("-1"))}else{this._super(value)}this._resetPagination()},cleanUpModel:function(){},_resetPagination:function(){this._pagination.lastQuery=this.getQueryVal();this._pagination.numberOfShowingItems=0;this._pagination.allResultsDisplayed=false;this._pagination.requestNextPagePromise=null}})});AJS.namespace("JIRA.AssigneePicker",null,require("jira/field/assignee-picker"));