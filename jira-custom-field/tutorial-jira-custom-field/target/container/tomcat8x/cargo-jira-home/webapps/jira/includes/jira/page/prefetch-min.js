define("jira/page/atl/prefetch",["jira/util/data/meta","jira/data/local-storage","jira/ajs/dark-features","jquery"],function definePrefetchResource(meta,storage,darkFeatures,jQuery){var SESSION_KEY="jira.issue.prefetch.last.superbatch";var stateToken=_getStateToken();function _getStateToken(){var now=new Date();var dateStr=now.getFullYear().toString()+now.getMonth().toString()+now.getDate().toString();var superbatch=jQuery("head > script").filter(function findSuperbatch(a,b){return b.src.indexOf("/_super")>0});return(superbatch.length>0?superbatch[0].src:"empty")+dateStr}function _addPrefetchTag(url){jQuery("<link />",{rel:"prefetch",href:url}).appendTo("head")}function _getLastIssueFromMenu(issueMenuData){var sections=issueMenuData.sections;if(!sections){return }var recentIssues=sections.filter(function filterMenu(menuItem){return menuItem.id==="issues_history_main"});if(recentIssues.length&&recentIssues[0].items.length!==0){var lastIssue=recentIssues[0].items[0];return lastIssue.url}}function _addPrefetchForRegex(response,regex){var matchResult;while(matchResult=regex.exec(response)){var url=matchResult[1].replace(/&amp;/g,"&");_addPrefetchTag(url)}}function _rememberFetchState(){storage.setItem(SESSION_KEY,stateToken)}function _parsePageAndInsertLinks(data){_addPrefetchForRegex(data,/<script.+?src="(.+?)".+?<\/script>/g);_addPrefetchForRegex(data,/<link.+?rel="stylesheet".+?href="(.+?)".+?>/g);_rememberFetchState()}function _shouldFetchResources(){if(!darkFeatures.isEnabled("jira.issue.prefetch")){return false}if(jQuery("#isNavigator").length===1){_rememberFetchState();return false}else{if(meta.get("issue-key")){_rememberFetchState();return false}else{return stateToken!==storage.getItem(SESSION_KEY)}}}function _prefetchResourcesForLastIssue(data){var issueUrl=_getLastIssueFromMenu(data);if(issueUrl){prefetchResourcesForUrl(issueUrl)}}function prefetchResourcesForUrl(url){jQuery.get(url,_parsePageAndInsertLinks)}function prefetchViewIssueResources(){if(_shouldFetchResources()){jQuery.ajax({url:AJS.contextPath()+"/rest/api/1.0/menus/find_link?inAdminMode=false",dataType:"json"}).done(_prefetchResourcesForLastIssue)}}return{prefetchResourcesForUrl:prefetchResourcesForUrl,prefetchViewIssueResources:prefetchViewIssueResources}});