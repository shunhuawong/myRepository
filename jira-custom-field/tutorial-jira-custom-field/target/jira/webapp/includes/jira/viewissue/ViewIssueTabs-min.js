define("jira/viewissue/tabs",["jquery","jira/util/data/meta","jira/dialog/form-dialog","jira/ajs/ajax/smart-ajax","jira/userhover/userhover","jira/viewissue/tabs/analytics"],function(jQuery,Meta,FormDialog,SmartAjax,Userhover,Analytics){var Format=AJS.format;var Templates=JIRA.Templates.Issue.Tabs;var useHistoryApi=Meta.get("viewissue-use-history-api")!==false;var AJAX_LOAD_CLASS="ajax-activity-content";var CONTAINER_SELECTOR="#activitymodule div.mod-content";var AJAX_LINK_SELECTOR=Format("a.{0}",AJAX_LOAD_CLASS);var issueTabLoadedListeners=[];var $tabWrapper,$tabContents;var xhrInProgress;function dispatchIssueTabLoadedEvent(container){container=container||document;jQuery.each(issueTabLoadedListeners,function(i,fn){fn(container)})}function bindToTabDivs(container){var $newTabWrapper=jQuery(container).find(".issuePanelWrapper");var $newTabContents=jQuery(container).find("#issue_actions_container");$tabContents=$newTabContents.length?$newTabContents:$tabContents;$tabWrapper=$newTabWrapper.length?$newTabWrapper:$tabWrapper}function dispatchIssueTabErrorEvent(smartAjaxResult,activeTabKey){var errorPopup=new FormDialog({id:"issue-tab-error-dialog",widthClass:"small",content:SmartAjax.buildDialogErrorContent(smartAjaxResult,false)});setActiveTab(activeTabKey);$tabContents.show();errorPopup.show()}function setActiveTab(activeTabKey){jQuery("#issue-tabs li").each(function(){var $li=jQuery(this);var tabKey=$li.data("key");var tabLabel=$li.data("label");if(tabKey==activeTabKey){$li.addClass("active");$li.html(Templates.label({text:tabLabel}))}else{$li.removeClass("active");var id=$li.data("id");var href=$li.data("href");$li.html(Templates.tab({id:id,href:href,linkClass:AJAX_LOAD_CLASS,text:tabLabel}))}});enableAjaxOnLinks(jQuery("#issue-tabs"))}function putTabInLoadingState(activeTabKey){setActiveTab(activeTabKey)}function isTriggerByKeyBoard(event,$trigger){var eventX=event.pageX;var eventY=event.pageY;var triggerOffset=$trigger.offset();var triggerWidth=$trigger.outerWidth();var triggerHeight=$trigger.outerHeight();if(eventX==0&&eventY==0){return true}else{return !(eventX>=triggerOffset.left&&eventX<=(triggerOffset.left+triggerWidth)&&eventY>=triggerOffset.top&&eventY<=(triggerOffset.top+triggerHeight))}}function enableAjaxOnLinks(context){var activeTabKey=jQuery(context).find("li.active").data("key");jQuery(context).find(AJAX_LINK_SELECTOR).click(function(event){var $trigger=jQuery(this);var isTriggerByKeyboard=isTriggerByKeyBoard(event,$trigger);var loadingTabKey=$trigger.parent().data("key");var openInNewWindow=event.metaKey;if(loadingTabKey){Analytics.tabClicked($trigger,openInNewWindow,isTriggerByKeyboard)}else{Analytics.buttonClicked($trigger,openInNewWindow,isTriggerByKeyboard)}if(openInNewWindow){return }event.preventDefault();if(loadingTabKey){putTabInLoadingState(loadingTabKey)}handleAjaxContentsLoading(activeTabKey,$trigger.attr("href")).done(function($container){if(!isTriggerByKeyboard){return }if(loadingTabKey){$container.find("#"+$trigger.attr("id")+" > :first-child").focus()}else{$container.find(".sortwrap  > :first-child").focus()}}).done(dispatchIssueTabLoadedEvent)})}function handleAjaxContentsLoading(activeTabKey,loadingUrl){var deferred=jQuery.Deferred();if(xhrInProgress){xhrInProgress.abort()}var xhr=SmartAjax.makeRequest({jqueryAjaxFn:useHistoryApi?jQuery.pjax:jQuery.ajax,headers:{"X-PJAX":true},container:CONTAINER_SELECTOR,url:loadingUrl,timeout:null,complete:function(xhr,status,smartAjaxResult){if(status!="abort"){xhrInProgress=null;if(!smartAjaxResult.successful){if(smartAjaxResult.status<300||smartAjaxResult.status>=400){dispatchIssueTabErrorEvent(smartAjaxResult,activeTabKey)}return }var $container=jQuery(this.container);var newElementsHtml=document.createElement("div");newElementsHtml.innerHTML=smartAjaxResult.data;var newElements=document.createDocumentFragment().appendChild(newElementsHtml);if(!useHistoryApi){smartUpdate($container,newElements)}JIRA.trace("jira.issue.tab.loaded");deferred.resolve($container)}}});jQuery(xhr).throbber({target:$tabWrapper});xhrInProgress=xhr;return deferred}function smartUpdate(container,newElements){var newTabs=newElements.querySelectorAll(".tabwrap");var oldTabs=container.find(".tabwrap");var newContents=jQuery(newElements.querySelectorAll("#issue_actions_container")).contents();var oldContents=$tabContents.contents();if(newTabs.length&&oldTabs.length&&newContents.length&&oldContents.length){oldTabs.replaceWith(newTabs);var currentContentHeight=$tabContents.height();$tabContents.append(newContents);var newContentHeight=$tabContents.height()-currentContentHeight;var visibleHeightDifference=jQuery(window).scrollTop()+jQuery(window).height()-($tabContents.offset().top+newContentHeight);if(visibleHeightDifference>0){$tabContents.css("height",newContentHeight+visibleHeightDifference);oldContents.remove();var preDelay=150;setTimeout(function(){var pixelsPerSecond=500;var animSpeed=visibleHeightDifference/pixelsPerSecond*1000;$tabContents.animate({height:newContentHeight},animSpeed,"easeOutQuart",function(){$tabContents.css("height","auto")})},preDelay)}else{$tabContents.empty().append(newContents)}jQuery(newElements.querySelectorAll("script")).each(function(){jQuery.globalEval(this.text||this.textContent||this.innerHTML||"")})}else{container.empty().append(newElements)}}function appendHashCodeToLinks(context){jQuery(context).find(AJAX_LINK_SELECTOR).each(function(){var $a=jQuery(this);$a.attr("href",$a.attr("href")+"#issue-tabs")})}function processActivityModuleLinks(context){if(!useHistoryApi||jQuery.support.pjax){enableAjaxOnLinks(context)}else{appendHashCodeToLinks(context)}}function setupMouseoverBehaviour(context){jQuery(context).bind("moveToFinished",function(event,target){jQuery("a.twixi:visible",target).focus()})}function initLivestamp(context){context.find("time.livestamp").livestamp()}function onTabReady(listener){if(jQuery.inArray(listener,issueTabLoadedListeners)<0){issueTabLoadedListeners.push(listener)}}onTabReady(bindToTabDivs);onTabReady(processActivityModuleLinks);onTabReady(setupMouseoverBehaviour);onTabReady(Userhover);onTabReady(initLivestamp);return{onTabReady:onTabReady,domReady:dispatchIssueTabLoadedEvent}});AJS.namespace("JIRA.ViewIssueTabs",null,require("jira/viewissue/tabs"));